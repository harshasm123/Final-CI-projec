AWSTemplateFormatVersion: '2010-09-09'
Description: 'CI Alert System - Pharmaceutical Competitive Intelligence Platform'

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
  
  BedrockAgentId:
    Type: String
    Description: Bedrock Agent ID for CI analysis
    Default: ''
  
  BedrockAgentAliasId:
    Type: String
    Description: Bedrock Agent Alias ID
    Default: 'TSTALIASID'
  
Resources:
  # S3 Buckets
  DataLakeBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ci-alert-datalake-${Environment}-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: ArchiveOldData
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
              - TransitionInDays: 90
                StorageClass: GLACIER

  ProcessedDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ci-alert-processed-${Environment}-${AWS::AccountId}'

  # OpenSearch Domain
  OpenSearchDomain:
    Type: AWS::OpenSearch::Domain
    Properties:
      DomainName: !Sub 'ci-search-${Environment}'
      EngineVersion: 'OpenSearch_2.3'
      ClusterConfig:
        InstanceType: t3.small.search
        InstanceCount: 1
        DedicatedMasterEnabled: false
      EBSOptions:
        EBSEnabled: true
        VolumeType: gp3
        VolumeSize: 20
      AccessPolicies:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'es:*'
            Resource: !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/ci-search-${Environment}/*'
      DomainEndpointOptions:
        EnforceHTTPS: true
      NodeToNodeEncryptionOptions:
        Enabled: true
      EncryptionAtRestOptions:
        Enabled: true

  # S3 Bucket for Metadata
  MetadataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ci-metadata-${Environment}-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # DynamoDB Table for Chatbot Conversations
  ConversationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'ci-chatbot-conversations-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: conversationId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
      KeySchema:
        - AttributeName: conversationId
          KeyType: HASH
        - AttributeName: createdAt
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: UserIdIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES

  # Lambda Execution Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CIAlertSystemPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource:
                  - !Sub '${DataLakeBucket}/*'
                  - !Sub '${ProcessedDataBucket}/*'
              - Effect: Allow
                Action:
                  - es:ESHttpPost
                  - es:ESHttpPut
                  - es:ESHttpGet
                  - es:ESHttpDelete
                Resource: !GetAtt OpenSearchDomain.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub '${MetadataBucket}/*'
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeAgent
                  - bedrock:Retrieve
                  - bedrock:RetrieveAndGenerate
                Resource: '*'
              - Effect: Allow
                Action:
                  - bedrock-agent-runtime:InvokeAgent
                Resource: '*'
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: !Ref AlertTopic
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt ConversationTable.Arn
                  - !Sub '${ConversationTable.Arn}/index/*'

  # SNS Topic for Alerts
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub 'ci-alerts-${Environment}'
      DisplayName: 'CI Alert System Notifications'

  # EventBridge Rule for Processing
  ProcessingRule:
    Type: AWS::Events::Rule
    Properties:
      Description: 'Trigger document processing'
      EventPattern:
        source: ['ci.alert.system']
        detail-type: ['Document Uploaded']
      Targets:
        - Arn: !GetAtt ProcessDocumentFunction.Arn
          Id: ProcessDocumentTarget

  # Lambda Functions
  # Comprehensive Data Ingestion Function
  ComprehensiveDataIngestionFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-comprehensive-ingestion-${Environment}'
      Runtime: python3.11
      Handler: comprehensive_data_ingestion.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 900
      MemorySize: 2048
      Environment:
        Variables:
          DATALAKE_BUCKET: !Ref DataLakeBucket
          METADATA_BUCKET: !Ref MetadataBucket
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          ALERT_TOPIC: !Ref AlertTopic
          FDA_API_KEY: '{{resolve:secretsmanager:ci-api-keys:SecretString:FDA_API_KEY}}'
          PUBMED_API_KEY: '{{resolve:secretsmanager:ci-api-keys:SecretString:PUBMED_API_KEY}}'
          CLINICALTRIALS_API_KEY: '{{resolve:secretsmanager:ci-api-keys:SecretString:CLINICALTRIALS_API_KEY}}'
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Comprehensive Data Ingestion')}

  # Data Quality Pipeline Function
  DataQualityPipelineFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-data-quality-pipeline-${Environment}'
      Runtime: python3.11
      Handler: data_quality_pipeline.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 600
      MemorySize: 1024
      Environment:
        Variables:
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          METADATA_BUCKET: !Ref MetadataBucket
          ALERT_TOPIC: !Ref AlertTopic
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Data Quality Pipeline')}

  DataIngestionFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-data-ingestion-${Environment}'
      Runtime: python3.11
      Handler: data_ingestion.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 900
      MemorySize: 1024
      Environment:
        Variables:
          DATALAKE_BUCKET: !Ref DataLakeBucket
          METADATA_BUCKET: !Ref MetadataBucket
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          ALERT_TOPIC: !Ref AlertTopic
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Data ingestion')}

  ProcessDocumentFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-process-document-${Environment}'
      Runtime: python3.11
      Handler: document_processor.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 900
      MemorySize: 3008
      Environment:
        Variables:
          PROCESSED_BUCKET: !Ref ProcessedDataBucket
          METADATA_BUCKET: !Ref MetadataBucket
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          ALERT_TOPIC: !Ref AlertTopic
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Document processing')}

  # PHASE 3 - AI & DATA PIPELINES
  # AI Handler Lambda Function
  AIHandlerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-ai-handler-${Environment}'
      Runtime: python3.11
      Handler: handlers.ai_handler.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 2048
      Environment:
        Variables:
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          METADATA_BUCKET: !Ref MetadataBucket
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('AI Handler')}

  # Alert Handler Lambda Function
  AlertHandlerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-alert-handler-${Environment}'
      Runtime: python3.11
      Handler: handlers.alert_handler.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          ALERT_TOPIC: !Ref AlertTopic
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Alert Handler')}

  # Competitive Analysis Handler Lambda Function
  CompetitiveAnalysisFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-competitive-analysis-${Environment}'
      Runtime: python3.11
      Handler: handlers.competitive_analysis.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 2048
      Environment:
        Variables:
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          METADATA_BUCKET: !Ref MetadataBucket
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Competitive Analysis')}

  # Brand Handler Lambda Function
  BrandHandlerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-brand-handler-${Environment}'
      Runtime: python3.11
      Handler: handlers.brand_handler.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 1024
      Environment:
        Variables:
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          METADATA_BUCKET: !Ref MetadataBucket
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Brand Handler')}

  # Dashboard Handler Lambda Function
  DashboardHandlerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-dashboard-handler-${Environment}'
      Runtime: python3.11
      Handler: handlers.dashboard_handler.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Dashboard Handler')}

  # Data Quality Check Lambda Function
  DataQualityCheckFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-data-quality-${Environment}'
      Runtime: python3.11
      Handler: handlers.data_quality.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      Environment:
        Variables:
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          METADATA_BUCKET: !Ref MetadataBucket
          ALERT_TOPIC: !Ref AlertTopic
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Data Quality Check')}

  # Chatbot Handler Lambda Function
  ChatbotHandlerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-chatbot-handler-${Environment}'
      Runtime: python3.11
      Handler: handlers.chatbot_handler.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 2048
      Environment:
        Variables:
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
          METADATA_BUCKET: !Ref MetadataBucket
          CONVERSATION_TABLE: !Ref ConversationTable
          BEDROCK_AGENT_ID: !Ref BedrockAgentId
          BEDROCK_AGENT_ALIAS_ID: !Ref BedrockAgentAliasId
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('Chatbot Handler')}

  APIFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ci-api-${Environment}'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 512
      Environment:
        Variables:
          METADATA_BUCKET: !Ref MetadataBucket
          OPENSEARCH_ENDPOINT: !GetAtt OpenSearchDomain.DomainEndpoint
      Code:
        ZipFile: |
          # Placeholder - deploy actual code
          import json
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': json.dumps('API')}

  # API Gateway
  RestAPI:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub 'ci-alert-api-${Environment}'
      Description: 'CI Alert System API'
      EndpointConfiguration:
        Types:
          - REGIONAL

  APIDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn: 
      - APIMethod
      - APILambdaPermission
    Properties:
      RestApiId: !Ref RestAPI
      StageName: !Ref Environment

  APIResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestAPI
      ParentId: !GetAtt RestAPI.RootResourceId
      PathPart: '{proxy+}'

  APIMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestAPI
      ResourceId: !Ref APIResource
      HttpMethod: ANY
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${APIFunction.Arn}/invocations'

  # Lambda Permissions
  APILambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref APIFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub '${RestAPI}/*/ANY/*'

  ProcessLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ProcessDocumentFunction
      Action: lambda:InvokeFunction
      Principal: s3.amazonaws.com
      SourceArn: !GetAtt ProcessedDataBucket.Arn

  # S3 Notification Configuration (after Lambda permission)
  ProcessedDataBucketNotification:
    Type: AWS::S3::Bucket
    DependsOn: ProcessLambdaPermission
    Properties:
      BucketName: !Sub 'ci-alert-processed-${Environment}-${AWS::AccountId}'
      NotificationConfiguration:
        LambdaConfigurations:
          - Event: s3:ObjectCreated:*
            Function: !GetAtt ProcessDocumentFunction.Arn

  # PHASE 3 Lambda Permissions
  AIHandlerLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AIHandlerFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*'

  AlertHandlerLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AlertHandlerFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*'

  CompetitiveAnalysisLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CompetitiveAnalysisFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*'

  BrandHandlerLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref BrandHandlerFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*'

  DashboardHandlerLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DashboardHandlerFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*'

  DataQualityCheckLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DataQualityCheckFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*'

  ChatbotHandlerLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ChatbotHandlerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestAPI}/*'

Outputs:
  APIEndpoint:
    Description: 'API Gateway endpoint URL'
    Value: !Sub 'https://${RestAPI}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-APIEndpoint'
  
  DataLakeBucket:
    Description: 'S3 bucket for raw data'
    Value: !Ref DataLakeBucket
    Export:
      Name: !Sub '${AWS::StackName}-DataLakeBucket'
  
  OpenSearchEndpoint:
    Description: 'OpenSearch domain endpoint'
    Value: !GetAtt OpenSearchDomain.DomainEndpoint
    Export:
      Name: !Sub '${AWS::StackName}-OpenSearchEndpoint'

  # PHASE 3 Outputs
  AIHandlerFunctionArn:
    Description: 'ARN of AI Handler Lambda function'
    Value: !GetAtt AIHandlerFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-AIHandlerArn'

  AlertHandlerFunctionArn:
    Description: 'ARN of Alert Handler Lambda function'
    Value: !GetAtt AlertHandlerFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-AlertHandlerArn'

  CompetitiveAnalysisFunctionArn:
    Description: 'ARN of Competitive Analysis Lambda function'
    Value: !GetAtt CompetitiveAnalysisFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CompetitiveAnalysisArn'

  BrandHandlerFunctionArn:
    Description: 'ARN of Brand Handler Lambda function'
    Value: !GetAtt BrandHandlerFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-BrandHandlerArn'

  DashboardHandlerFunctionArn:
    Description: 'ARN of Dashboard Handler Lambda function'
    Value: !GetAtt DashboardHandlerFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-DashboardHandlerArn'

  DataQualityCheckFunctionArn:
    Description: 'ARN of Data Quality Check Lambda function'
    Value: !GetAtt DataQualityCheckFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-DataQualityCheckArn'

  ChatbotHandlerFunctionArn:
    Description: 'ARN of Chatbot Handler Lambda function'
    Value: !GetAtt ChatbotHandlerFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ChatbotHandlerArn'

  ConversationTableName:
    Description: 'DynamoDB table for chatbot conversations'
    Value: !Ref ConversationTable
    Export:
      Name: !Sub '${AWS::StackName}-ConversationTable'